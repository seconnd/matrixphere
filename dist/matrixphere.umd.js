(function(h,p){typeof exports=="object"&&typeof module<"u"?p(exports):typeof define=="function"&&define.amd?define(["exports"],p):(h=typeof globalThis<"u"?globalThis:h||self,p(h.Matrixphere={}))})(this,function(h){"use strict";var Ft=h=>{throw TypeError(h)};var Dt=(h,p,_)=>p.has(h)||Ft("Cannot "+_);var l=(h,p,_)=>(Dt(h,p,"read from private field"),_?_.call(h):p.get(h)),d=(h,p,_)=>p.has(h)?Ft("Cannot add the same private member more than once"):p instanceof WeakSet?p.add(h):p.set(h,_),f=(h,p,_,j)=>(Dt(h,p,"write to private field"),j?j.call(h,_):p.set(h,_),_);var C,N,k,F,D,H,L,J,V,B,Y,K,W,z,X,G,q,Q,A,Z,tt;var p=function(i,r){return p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s])},p(i,r)};function _(i,r){if(typeof r!="function"&&r!==null)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");p(i,r);function t(){this.constructor=i}i.prototype=r===null?Object.create(r):(t.prototype=r.prototype,new t)}function j(i){var r=typeof Symbol=="function"&&Symbol.iterator,t=r&&i[r],e=0;if(t)return t.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&e>=i.length&&(i=void 0),{value:i&&i[e++],done:!i}}};throw new TypeError(r?"Object is not iterable.":"Symbol.iterator is not defined.")}function ot(i,r){var t=typeof Symbol=="function"&&i[Symbol.iterator];if(!t)return i;var e=t.call(i),s,n=[],o;try{for(;(r===void 0||r-- >0)&&!(s=e.next()).done;)n.push(s.value)}catch(a){o={error:a}}finally{try{s&&!s.done&&(t=e.return)&&t.call(e)}finally{if(o)throw o.error}}return n}function ut(i,r,t){if(t||arguments.length===2)for(var e=0,s=r.length,n;e<s;e++)(n||!(e in r))&&(n||(n=Array.prototype.slice.call(r,0,e)),n[e]=r[e]);return i.concat(n||Array.prototype.slice.call(r))}typeof SuppressedError=="function"&&SuppressedError;function O(i){return typeof i=="function"}function mt(i){var r=function(e){Error.call(e),e.stack=new Error().stack},t=i(r);return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var at=mt(function(i){return function(t){i(this),this.message=t?t.length+` errors occurred during unsubscription:
`+t.map(function(e,s){return s+1+") "+e.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=t}});function ct(i,r){if(i){var t=i.indexOf(r);0<=t&&i.splice(t,1)}}var et=function(){function i(r){this.initialTeardown=r,this.closed=!1,this._parentage=null,this._finalizers=null}return i.prototype.unsubscribe=function(){var r,t,e,s,n;if(!this.closed){this.closed=!0;var o=this._parentage;if(o)if(this._parentage=null,Array.isArray(o))try{for(var a=j(o),u=a.next();!u.done;u=a.next()){var c=u.value;c.remove(this)}}catch($){r={error:$}}finally{try{u&&!u.done&&(t=a.return)&&t.call(a)}finally{if(r)throw r.error}}else o.remove(this);var g=this.initialTeardown;if(O(g))try{g()}catch($){n=$ instanceof at?$.errors:[$]}var y=this._finalizers;if(y){this._finalizers=null;try{for(var x=j(y),E=x.next();!E.done;E=x.next()){var U=E.value;try{St(U)}catch($){n=n??[],$ instanceof at?n=ut(ut([],ot(n)),ot($.errors)):n.push($)}}}catch($){e={error:$}}finally{try{E&&!E.done&&(s=x.return)&&s.call(x)}finally{if(e)throw e.error}}}if(n)throw new at(n)}},i.prototype.add=function(r){var t;if(r&&r!==this)if(this.closed)St(r);else{if(r instanceof i){if(r.closed||r._hasParent(this))return;r._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(r)}},i.prototype._hasParent=function(r){var t=this._parentage;return t===r||Array.isArray(t)&&t.includes(r)},i.prototype._addParent=function(r){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(r),t):t?[t,r]:r},i.prototype._removeParent=function(r){var t=this._parentage;t===r?this._parentage=null:Array.isArray(t)&&ct(t,r)},i.prototype.remove=function(r){var t=this._finalizers;t&&ct(t,r),r instanceof i&&r._removeParent(this)},i.EMPTY=function(){var r=new i;return r.closed=!0,r}(),i}(),wt=et.EMPTY;function $t(i){return i instanceof et||i&&"closed"in i&&O(i.remove)&&O(i.add)&&O(i.unsubscribe)}function St(i){O(i)?i():i.unsubscribe()}var Ht={Promise:void 0},Lt={setTimeout:function(i,r){for(var t=[],e=2;e<arguments.length;e++)t[e-2]=arguments[e];return setTimeout.apply(void 0,ut([i,r],ot(t)))},clearTimeout:function(i){return clearTimeout(i)},delegate:void 0};function Jt(i){Lt.setTimeout(function(){throw i})}function xt(){}function rt(i){i()}var Et=function(i){_(r,i);function r(t){var e=i.call(this)||this;return e.isStopped=!1,t?(e.destination=t,$t(t)&&t.add(e)):e.destination=Yt,e}return r.create=function(t,e,s){return new lt(t,e,s)},r.prototype.next=function(t){this.isStopped||this._next(t)},r.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},r.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},r.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,i.prototype.unsubscribe.call(this),this.destination=null)},r.prototype._next=function(t){this.destination.next(t)},r.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},r.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},r}(et),Vt=function(){function i(r){this.partialObserver=r}return i.prototype.next=function(r){var t=this.partialObserver;if(t.next)try{t.next(r)}catch(e){it(e)}},i.prototype.error=function(r){var t=this.partialObserver;if(t.error)try{t.error(r)}catch(e){it(e)}else it(r)},i.prototype.complete=function(){var r=this.partialObserver;if(r.complete)try{r.complete()}catch(t){it(t)}},i}(),lt=function(i){_(r,i);function r(t,e,s){var n=i.call(this)||this,o;return O(t)||!t?o={next:t??void 0,error:e??void 0,complete:s??void 0}:o=t,n.destination=new Vt(o),n}return r}(Et);function it(i){Jt(i)}function Bt(i){throw i}var Yt={closed:!0,next:xt,error:Bt,complete:xt},Kt=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function Wt(i){return i}function zt(i){return i.length===0?Wt:i.length===1?i[0]:function(t){return i.reduce(function(e,s){return s(e)},t)}}var Ot=function(){function i(r){r&&(this._subscribe=r)}return i.prototype.lift=function(r){var t=new i;return t.source=this,t.operator=r,t},i.prototype.subscribe=function(r,t,e){var s=this,n=Gt(r)?r:new lt(r,t,e);return rt(function(){var o=s,a=o.operator,u=o.source;n.add(a?a.call(n,u):u?s._subscribe(n):s._trySubscribe(n))}),n},i.prototype._trySubscribe=function(r){try{return this._subscribe(r)}catch(t){r.error(t)}},i.prototype.forEach=function(r,t){var e=this;return t=Tt(t),new t(function(s,n){var o=new lt({next:function(a){try{r(a)}catch(u){n(u),o.unsubscribe()}},error:n,complete:s});e.subscribe(o)})},i.prototype._subscribe=function(r){var t;return(t=this.source)===null||t===void 0?void 0:t.subscribe(r)},i.prototype[Kt]=function(){return this},i.prototype.pipe=function(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];return zt(r)(this)},i.prototype.toPromise=function(r){var t=this;return r=Tt(r),new r(function(e,s){var n;t.subscribe(function(o){return n=o},function(o){return s(o)},function(){return e(n)})})},i.create=function(r){return new i(r)},i}();function Tt(i){var r;return(r=i??Ht.Promise)!==null&&r!==void 0?r:Promise}function Xt(i){return i&&O(i.next)&&O(i.error)&&O(i.complete)}function Gt(i){return i&&i instanceof Et||Xt(i)&&$t(i)}var qt=mt(function(i){return function(){i(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),At=function(i){_(r,i);function r(){var t=i.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return r.prototype.lift=function(t){var e=new Pt(this,this);return e.operator=t,e},r.prototype._throwIfClosed=function(){if(this.closed)throw new qt},r.prototype.next=function(t){var e=this;rt(function(){var s,n;if(e._throwIfClosed(),!e.isStopped){e.currentObservers||(e.currentObservers=Array.from(e.observers));try{for(var o=j(e.currentObservers),a=o.next();!a.done;a=o.next()){var u=a.value;u.next(t)}}catch(c){s={error:c}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(s)throw s.error}}}})},r.prototype.error=function(t){var e=this;rt(function(){if(e._throwIfClosed(),!e.isStopped){e.hasError=e.isStopped=!0,e.thrownError=t;for(var s=e.observers;s.length;)s.shift().error(t)}})},r.prototype.complete=function(){var t=this;rt(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var e=t.observers;e.length;)e.shift().complete()}})},r.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(r.prototype,"observed",{get:function(){var t;return((t=this.observers)===null||t===void 0?void 0:t.length)>0},enumerable:!1,configurable:!0}),r.prototype._trySubscribe=function(t){return this._throwIfClosed(),i.prototype._trySubscribe.call(this,t)},r.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},r.prototype._innerSubscribe=function(t){var e=this,s=this,n=s.hasError,o=s.isStopped,a=s.observers;return n||o?wt:(this.currentObservers=null,a.push(t),new et(function(){e.currentObservers=null,ct(a,t)}))},r.prototype._checkFinalizedStatuses=function(t){var e=this,s=e.hasError,n=e.thrownError,o=e.isStopped;s?t.error(n):o&&t.complete()},r.prototype.asObservable=function(){var t=new Ot;return t.source=this,t},r.create=function(t,e){return new Pt(t,e)},r}(Ot),Pt=function(i){_(r,i);function r(t,e){var s=i.call(this)||this;return s.destination=t,s.source=e,s}return r.prototype.next=function(t){var e,s;(s=(e=this.destination)===null||e===void 0?void 0:e.next)===null||s===void 0||s.call(e,t)},r.prototype.error=function(t){var e,s;(s=(e=this.destination)===null||e===void 0?void 0:e.error)===null||s===void 0||s.call(e,t)},r.prototype.complete=function(){var t,e;(e=(t=this.destination)===null||t===void 0?void 0:t.complete)===null||e===void 0||e.call(t)},r.prototype._subscribe=function(t){var e,s;return(s=(e=this.source)===null||e===void 0?void 0:e.subscribe(t))!==null&&s!==void 0?s:wt},r}(At);class Rt extends At{constructor(){super(),this.pipe0=super.pipe,this.pipe=r=>{let t=this.pipe0(r);return t.subscribe0=t.subscribe,t.subscribe=e=>{if(!e.hasOwnProperty("next"))throw"no exist next! in subscribe({ ... })";return t.subscribe0({next:s=>e.next(s),complete:e.complete||void 0,error:e.complete||void 0})},t}}}function v(i){return`Minified Redux error #${i}; visit https://redux.js.org/Errors?code=${i} for the full message or use the non-minified dev environment for full errors. `}var Qt=typeof Symbol=="function"&&Symbol.observable||"@@observable",Ut=Qt,ht=()=>Math.random().toString(36).substring(7).split("").join("."),Zt={INIT:`@@redux/INIT${ht()}`,REPLACE:`@@redux/REPLACE${ht()}`,PROBE_UNKNOWN_ACTION:()=>`@@redux/PROBE_UNKNOWN_ACTION${ht()}`},st=Zt;function te(i){if(typeof i!="object"||i===null)return!1;let r=i;for(;Object.getPrototypeOf(r)!==null;)r=Object.getPrototypeOf(r);return Object.getPrototypeOf(i)===r||Object.getPrototypeOf(i)===null}function It(i,r,t){if(typeof i!="function")throw new Error(v(2));if(typeof r=="function"&&typeof t=="function"||typeof t=="function"&&typeof arguments[3]=="function")throw new Error(v(0));if(typeof r=="function"&&typeof t>"u"&&(t=r,r=void 0),typeof t<"u"){if(typeof t!="function")throw new Error(v(1));return t(It)(i,r)}let e=i,s=r,n=new Map,o=n,a=0,u=!1;function c(){o===n&&(o=new Map,n.forEach((m,T)=>{o.set(T,m)}))}function g(){if(u)throw new Error(v(3));return s}function y(m){if(typeof m!="function")throw new Error(v(4));if(u)throw new Error(v(5));let T=!0;c();const I=a++;return o.set(I,m),function(){if(T){if(u)throw new Error(v(6));T=!1,c(),o.delete(I),n=null}}}function x(m){if(!te(m))throw new Error(v(7));if(typeof m.type>"u")throw new Error(v(8));if(typeof m.type!="string")throw new Error(v(17));if(u)throw new Error(v(9));try{u=!0,s=e(s,m)}finally{u=!1}return(n=o).forEach(I=>{I()}),m}function E(m){if(typeof m!="function")throw new Error(v(10));e=m,x({type:st.REPLACE})}function U(){const m=y;return{subscribe(T){if(typeof T!="object"||T===null)throw new Error(v(11));function I(){const kt=T;kt.next&&kt.next(g())}return I(),{unsubscribe:m(I)}},[Ut](){return this}}}return x({type:st.INIT}),{dispatch:x,subscribe:y,getState:g,replaceReducer:E,[Ut]:U}}function jt(i,r,t){return It(i,r,t)}function ee(i){Object.keys(i).forEach(r=>{const t=i[r];if(typeof t(void 0,{type:st.INIT})>"u")throw new Error(v(12));if(typeof t(void 0,{type:st.PROBE_UNKNOWN_ACTION()})>"u")throw new Error(v(13))})}function P(i){const r=Object.keys(i),t={};for(let n=0;n<r.length;n++){const o=r[n];typeof i[o]=="function"&&(t[o]=i[o])}const e=Object.keys(t);let s;try{ee(t)}catch(n){s=n}return function(o={},a){if(s)throw s;let u=!1;const c={};for(let g=0;g<e.length;g++){const y=e[g],x=t[y],E=o[y],U=x(E,a);if(typeof U>"u")throw a&&a.type,new Error(v(14));c[y]=U,u=u||U!==E}return u=u||e.length!==Object.keys(o).length,u?c:o}}function Mt(...i){return i.length===0?r=>r:i.length===1?i[0]:i.reduce((r,t)=>(...e)=>r(t(...e)))}function re(...i){return r=>(t,e)=>{const s=r(t,e);let n=()=>{throw new Error(v(15))};const o={getState:s.getState,dispatch:(u,...c)=>n(u,...c)},a=i.map(u=>u(o));return n=Mt(...a)(s.dispatch),{...s,dispatch:n}}}const M={UNDO:"@@redux-undo/UNDO",REDO:"@@redux-undo/REDO",JUMP_TO_FUTURE:"@@redux-undo/JUMP_TO_FUTURE",JUMP_TO_PAST:"@@redux-undo/JUMP_TO_PAST",JUMP:"@@redux-undo/JUMP",CLEAR_HISTORY:"@@redux-undo/CLEAR_HISTORY"};function dt(i,r=[]){return Array.isArray(i)?i:typeof i=="string"?[i]:r}function ie(i){return typeof i.present<"u"&&typeof i.future<"u"&&typeof i.past<"u"&&Array.isArray(i.future)&&Array.isArray(i.past)}function ft(i){const r=dt(i);return t=>r.indexOf(t.type)>=0}function R(i,r,t,e=null){return{past:i,present:r,future:t,group:e,_latestUnfiltered:r,index:i.length,limit:i.length+t.length+1}}let nt,w;const pt={prevState:"#9E9E9E",action:"#03A9F4",nextState:"#4CAF50"};function se(){w={header:[],prev:[],action:[],next:[],msgs:[]}}function ne(){const{header:i,prev:r,next:t,action:e,msgs:s}=w;console.group?(console.groupCollapsed(...i),console.log(...r),console.log(...e),console.log(...t),console.log(...s),console.groupEnd()):(console.log(...i),console.log(...r),console.log(...e),console.log(...t),console.log(...s))}function yt(i,r,t){return[`%c${i}`,`color: ${r}; font-weight: bold`,t]}function oe(i,r){se(),nt&&(console.group?(w.header=["%credux-undo","font-style: italic","action",i.type],w.action=yt("action",pt.action,i),w.prev=yt("prev history",pt.prevState,r)):(w.header=["redux-undo action",i.type],w.action=["action",i],w.prev=["prev history",r]))}function S(i){nt&&(console.group?w.next=yt("next history",pt.nextState,i):w.next=["next history",i],ne())}function b(...i){nt&&(w.msgs=w.msgs.concat([...i,`
`]))}function ue(i){nt=i}function vt(i,r){const t=R([],i,[]);return r&&(t._latestUnfiltered=null),t}function ae(i,r,t,e){const s=i.past.length+1;b("inserting",r),b("new free: ",t-s);const{past:n,_latestUnfiltered:o}=i,a=t&&t<=s,u=n.slice(a?1:0),c=o!=null?[...u,o]:u;return R(c,r,[],e)}function Ct(i,r){if(r<0||r>=i.future.length)return i;const{past:t,future:e,_latestUnfiltered:s}=i,n=[...t,s,...e.slice(0,r)],o=e[r],a=e.slice(r+1);return R(n,o,a)}function Nt(i,r){if(r<0||r>=i.past.length)return i;const{past:t,future:e,_latestUnfiltered:s}=i,n=t.slice(0,r),o=[...t.slice(r+1),s,...e],a=t[r];return R(n,a,o)}function bt(i,r){return r>0?Ct(i,r-1):r<0?Nt(i,i.past.length+r):i}function ce(i,r){return r.indexOf(i)>-1?i:!i}function _t(i,r={}){ue(r.debug);const t={limit:void 0,filter:()=>!0,groupBy:()=>null,undoType:M.UNDO,redoType:M.REDO,jumpToPastType:M.JUMP_TO_PAST,jumpToFutureType:M.JUMP_TO_FUTURE,jumpType:M.JUMP,neverSkipReducer:!1,ignoreInitialState:!1,syncFilter:!1,...r,initTypes:dt(r.initTypes,["@@redux-undo/INIT"]),clearHistoryType:dt(r.clearHistoryType,[M.CLEAR_HISTORY])},e=t.neverSkipReducer?(n,o,...a)=>({...n,present:i(n.present,o,...a)}):n=>n;let s;return(n=s,o={},...a)=>{oe(o,n);let u=n;if(!s)if(b("history is uninitialized"),n===void 0){const g=i(n,{type:"@@redux-undo/CREATE_HISTORY"},...a);return u=vt(g,t.ignoreInitialState),b("do not set initialState on probe actions"),S(u),u}else ie(n)?(u=s=t.ignoreInitialState?n:R(n.past,n.present,n.future),b("initialHistory initialized: initialState is a history",s)):(u=s=vt(n,t.ignoreInitialState),b("initialHistory initialized: initialState is not a history",s));let c;switch(o.type){case void 0:return u;case t.undoType:return c=bt(u,-1),b("perform undo"),S(c),e(c,o,...a);case t.redoType:return c=bt(u,1),b("perform redo"),S(c),e(c,o,...a);case t.jumpToPastType:return c=Nt(u,o.index),b(`perform jumpToPast to ${o.index}`),S(c),e(c,o,...a);case t.jumpToFutureType:return c=Ct(u,o.index),b(`perform jumpToFuture to ${o.index}`),S(c),e(c,o,...a);case t.jumpType:return c=bt(u,o.index),b(`perform jump to ${o.index}`),S(c),e(c,o,...a);case ce(o.type,t.clearHistoryType):return c=vt(u.present,t.ignoreInitialState),b("perform clearHistory"),S(c),e(c,o,...a);default:if(c=i(u.present,o,...a),t.initTypes.some(y=>y===o.type))return b("reset history due to init action"),S(s),s;if(u._latestUnfiltered===c)return u;if(typeof t.filter=="function"&&!t.filter(o,c,u)){const y=R(u.past,c,u.future,u.group);return t.syncFilter||(y._latestUnfiltered=u._latestUnfiltered),b("filter ignored action, not storing it in past"),S(y),y}const g=t.groupBy(o,c,u);if(g!=null&&g===u.group){const y=R(u.past,c,u.future,u.group);return b("groupBy grouped the action with the previous action"),S(y),y}return u=ae(u,c,t.limit,g),b("inserted new state into history"),S(u),u}}}class le{constructor(r){}}class he{}class gt extends le{constructor(r){super(r),this.next=null,this.prev=null,this.value=r}}class de extends he{constructor(){super(...arguments),this.head=null,this.tail=null}push(r){const t=new gt(r);return this.head?(t.prev=this.tail,this.tail&&(this.tail.next=t),this.tail=t):(this.head=t,this.tail=t),this}unshift(r){const t=new gt(r);return this.head?(t.next=this.head,this.head.prev=t,this.head=t):(this.head=t,this.tail=t),this}insertAt(r,t){if(r<=0)return this.unshift(t);let e=this.head,s=0;for(;e&&s<r;)e=e.next,s++;const n=new gt(t);if(e)n.prev=e.prev,n.next=e,e.prev&&(e.prev.next=n),e.prev=n,e===this.head&&(this.head=n);else return this.push(t);return this}removeAt(r){if(r<0)return this;let t=this.head,e=0;for(;t&&e<r;)t=t.next,e++;return t?(t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,this):this}pop(){if(!this.tail)return{value:null,list:this};const r=this.tail.value;return this.tail.prev?(this.tail=this.tail.prev,this.tail.next=null):(this.head=null,this.tail=null),{value:r,list:this}}shift(){if(!this.head)return{value:null,list:this};const r=this.head.value;return this.head.next?(this.head=this.head.next,this.head.prev=null):(this.head=null,this.tail=null),{value:r,list:this}}find(r){let t=this.head,e=0;for(;t;){if(r(t.value,e))return t.value;t=t.next,e++}return null}findIndex(r){let t=this.head,e=0;for(;t;){if(r(t.value,e))return e;t=t.next,e++}return-1}toArray(){const r=[];let t=this.head;for(;t;)r.push(t.value),t=t.next;return r}getValue(){return this.head?this.head.value:null}}class fe{constructor(){this.reducers={},this.recordReducers={},this.actions=new Map,this.recordActions=new Map,this.observables=new Map,this.methods=new Map,this.parameters=new Map}}class pe extends fe{constructor(){super();d(this,C);this.setMiddleware=()=>{if(!this.store)return t=>e=>s=>{const n=s.type.split("_")[0];let o={name:n,state:this.store.getState()[n],action:s};s.dispatched={name:o.name,state:o.state};let a;if(!(s.type.includes("_undo")||s.type.includes("_redo"))){if(this.observables.has(`${n}_before`))this.observables.get(`${n}_before`).next(s);else if(this.methods.has(`${n}_before`)){const u=this.methods.get(`${n}_before`);u&&(a=l(this,C).call(this,u(s)),a.dispatched=s.dispatched)}}return this.store.dispatched.push(o),a&&(s=a),e(s)}},f(this,C,t=>{if(!t.hasOwnProperty("type"))throw"No exist action.type property.";if(typeof t.type!="string")throw"action.type is not 'string' type.";if(!t.hasOwnProperty("value"))throw"No exist action.value property.";return t})}}C=new WeakMap;class ye extends pe{constructor(){super();d(this,N);d(this,k);d(this,F);this.setRecord=()=>{l(this,N).call(this),l(this,k).call(this),l(this,F).call(this)},f(this,N,()=>{this.record||(this.record=jt(P({start$:(t={})=>t})))}),f(this,k,()=>{this.record.dispatch0=this.record.dispatch,this.record.dispatched=null,this.record.dispatch=t=>{const e=t.type.split("_")[0];let s={name:e,state:this.record.getState()[e],action:t};t.dispatched={name:s.name,state:s.state},this.record.dispatched=s,this.record.dispatch0(t)}}),f(this,F,()=>{this.record.subscribe(()=>{if(this.record.current=this.record.getState(),!this.record.dispatched)return;const t=this.record.dispatched.action.type;if(t.substring(t.length-5,t.length)==="_undo"){const e=this.record.dispatched.state.past;if(e.length===0)return;this.store.dispatch({type:`${this.record.dispatched.name}_undo`,value:e[e.length-1]});return}if(t.substring(t.length-5,t.length)==="_redo"){const e=this.record.dispatched.state.future;if(e.length===0)return;this.store.dispatch({type:`${this.record.dispatched.name}_redo`,value:e[0]});return}})}),this.createRecordState=t=>{let{name:e,initialState:s}=t;if(this.recordReducers.hasOwnProperty(e))return;let n=Date.now();this.recordActions.set(`${e}_update`,(a,u)=>u.value);let o=(a={value:`${e} created.`,timestamp:n},u)=>{if(o.stateName!==u.type.split("_")[0]||!this.recordActions.has(u.type))return a;const c=this.recordActions.get(u.type);return c?c(a,u):a};o.stateName=e,this.recordReducers[e]=_t(o,{limit:1e3,filter:ft(Array.from(this.recordActions.keys())),undoType:`${e}_undo`,redoType:`${e}_redo`}),this.record.replaceReducer(P(this.recordReducers)),this.store.currentRecord=this.record.getState(),this.record.dispatch({type:`${e}_update`,value:{value:s==null?void 0:s.value,timestamp:n}})}}}N=new WeakMap,k=new WeakMap,F=new WeakMap;class ve extends ye{constructor(){super();d(this,D);d(this,H);d(this,L);d(this,J);d(this,V);d(this,B);d(this,Y);d(this,K);d(this,W);d(this,z);d(this,X);d(this,G);d(this,q);this.setStore=()=>(l(this,D).call(this),l(this,H).call(this),l(this,L).call(this),l(this,V).call(this),l(this,B).call(this),l(this,Y).call(this),l(this,K).call(this),l(this,W).call(this),l(this,z).call(this),l(this,X).call(this),l(this,G).call(this),l(this,q).call(this),this.store),f(this,D,()=>{if(this.store)return;const t=window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__||Mt;let e=this.store=jt(P({start$:(s={})=>s}),t(re(this.setMiddleware())));e.dispatched=new de,e.current=e.getState(),e.currentRecord={}}),f(this,H,()=>{let t=this.store;t.subscribe(()=>{let e=t.dispatched.shift().value;if(t.current=t.getState(),t.getStateR&&(t.currentRecord=t.getStateR()),!e||e.action.type==="initial$_delete"||e.action.type==="history$_update")return;let s=e.action.type;if(s==="history$_undo"){let n=t.current.history$.future[0].value;switch(n.name){case"initial$":t.remove&&t.remove(n.value.name,"undo");return;case"delete$":let o=this.parameters.get(n.value);o&&this.setValueState(o,"undo");return;default:this.record.dispatch({type:`${n.name}_undo`});return}}if(s==="history$_redo"){let n=t.current.history$.present.value;switch(n.name){case"initial$":let o=this.parameters.get(n.value.name);o&&this.setValueState(o,"redo");return;case"delete$":t.remove&&t.remove(n.value,"redo");return;default:this.record.dispatch({type:`${n.name}_redo`});return}}if(s.substring(s.length-5,s.length)==="_undo"){this.observables.has(`${e.name}_undo`)&&this.observables.get(`${e.name}_undo`).next(e.action);return}else if(s.substring(s.length-5,s.length)==="_redo"){this.observables.has(`${e.name}_redo`)&&this.observables.get(`${e.name}_redo`).next(e.action);return}else{if(e.name==="initial$"&&e.action.isSilent)return;t.dispatch({type:"history$_update",value:{name:e.name,value:e.action.value}}),this.record.dispatch({type:`${e.name}_update`,value:{value:e.action.value,timestamp:Date.now()}})}s.substring(s.length-7,s.length)==="_update"&&e.name!=="initial$"&&(this.parameters.get(e.name).inputState=t.current[e.name]),this.observables.has(`${e.name}_after`)&&this.observables.get(`${e.name}_after`).next(e.action)})}),f(this,L,()=>{this.store.set=(t,e="value")=>{switch(e){case"value":this.setValueState&&this.setValueState(t);break;case"film":l(this,J).call(this,t.name);break}}}),f(this,J,t=>{if(t.includes("$"))throw"State name must not contain '$'. '$' is automatically assigned in state name.";if(t==="initial")throw"Cannot create 'initial$' state, 'initial$' is system state.";if(t==="history")throw"Cannot create 'history$' state, 'history$' is system state.";const e=(s={value:`${t}$ created.`,timestamp:Date.now()},n)=>n.type===`${t}$`?{value:n.value,timestamp:Date.now()}:s;this.reducers[`${t}$`]=_t(e,{limit:1e3,filter:ft([`${t}$`]),undoType:`${t}$_undo`,redoType:`${t}$_redo`}),this.store.replaceReducer(P(this.reducers))}),f(this,V,()=>{let t=this.store;t.get=e=>{if(!t.current.hasOwnProperty(e))return console.warn(`no exist property[ ${e} ]`),null;if(e==="initial$")return t.current.initial$;if(e.includes("$"))return{past:t.current[e].past,present:t.current[e].present,future:t.current[e].future};if(t.current[e].hasOwnProperty("value"))return t.current[e].value}}),f(this,B,()=>{let t=this.store;t.update=(e,s)=>{if(e.substring(e.length-1,e.length)==="$")throw`Cannot access ${e}$ state, please access via revert() or replay().`;if(!this.reducers.hasOwnProperty(e)){console.warn(`no exist property[ ${e} ]`);return}t.dispatch({type:`${e}_update`,value:s})}}),f(this,Y,()=>{let t=this.store;t.capture=(e,s)=>{if(e==="initial"||e==="initial$")throw"Cannot access 'initial$' state, 'initial$' is system state.";if(e==="history"||e==="history$")throw"Cannot access 'history$' state, 'history$' is system state.";if(e.includes("$")||(e+="$"),!t.current.hasOwnProperty(e))return console.warn(`no exist property[ ${e} ]`),null;let n={type:`${e}`,value:s};t.dispatch(n)}}),f(this,K,()=>{let t=this.store;t.remove=(e,s)=>{if(!this.reducers.hasOwnProperty(e)){console.warn(`no exist property[ ${e} ]`);return}Array.from(this.actions.keys()).forEach(n=>{n.includes(`${e}_`)&&this.actions.delete(n)}),Array.from(this.observables.keys()).forEach(n=>{n.includes(`${e}_`)&&(this.observables.get(n).unsubscribe(),this.observables.delete(n))}),Array.from(this.methods.keys()).forEach(n=>{n.includes(`${e}_`)&&this.methods.delete(n)}),t.dispatch({type:"initial$_delete",value:{name:e}}),s?s==="undo"?this.record.dispatch({type:`${e}_undo`}):s==="redo"&&this.record.dispatch({type:`${e}_redo`}):(t.dispatch({type:"history$_update",value:{name:"delete$",value:e}}),this.record.dispatch({type:`${e}_update`,value:"delete$"})),delete this.reducers[e],t.replaceReducer(P(this.reducers))}}),f(this,W,()=>{let t=this.store;t.action=(e,s,n)=>{if(!this.reducers.hasOwnProperty(e)){console.warn(`no exist property[ ${e} ]`);return}if(!this.actions.has(`${e}_${s}`)){console.warn(`no exist action[ ${s} ]`);return}t.dispatch({type:`${e}_${s}`,value:n})}}),f(this,z,()=>{let t=this.store;t.undo=()=>{t.current.history$.past.length!==0&&t.dispatch({type:"history$_undo"})},t.redo=()=>{t.current.history$.future.length!==0&&t.dispatch({type:"history$_redo"})}}),f(this,X,()=>{let t=this.store;t.revert=e=>{},t.replay=e=>{}}),f(this,G,()=>{const t=(s={},n)=>n.type==="initial$_update"?(s[n.value.name]=n.value.value,s):(n.type==="initial$_delete"&&delete s[n.value.name],s);this.reducers.initial$=t;const e=_t((s={value:"history$ created.",timestamp:Date.now()},n)=>{if(!n.type)return s;switch(n.type){case"history$_update":return{value:n.value,timestamp:Date.now()};case"history$_undo":return{value:n.value.value,timestamp:n.value.timestamp};case"history$_redo":return{value:n.value.value,timestamp:n.value.timestamp}}return s},{limit:1e3,filter:ft(["history$_update"]),undoType:"history$_undo",redoType:"history$_redo"});this.reducers.history$=e,this.store.replaceReducer(P(this.reducers))}),f(this,q,()=>{this.store.getStateR=()=>this.record.getState()}),this.setValueState=(t,e=!1)=>{}}}D=new WeakMap,H=new WeakMap,L=new WeakMap,J=new WeakMap,V=new WeakMap,B=new WeakMap,Y=new WeakMap,K=new WeakMap,W=new WeakMap,z=new WeakMap,X=new WeakMap,G=new WeakMap,q=new WeakMap;class be extends ve{constructor(){super();d(this,Q);d(this,A);d(this,Z);d(this,tt);this.setReducer=()=>{Object.keys(this.reducers).length>0},this.setValueState=(t,e=!1)=>{let{name:s}=t;if(s.includes("_"))throw"'_' cannot be used in state name.";if(s.includes("$")&&s!=="history$")throw"'$' cannot be used in state name.";this.reducers[s]||(e||(t.initialState={value:t.value,timestamp:Date.now()},t.inputState=t.initialState),this.createRecordState(t),l(this,Q).call(this,t),l(this,tt).call(this,l(this,Z).call(this,t),e))},f(this,Q,t=>{let e=this.actions,s=this.methods,n=this.observables;if(e.set(`${t.name}_update`,(o,a)=>({value:a.value,timestamp:Date.now()})),t.before&&(typeof t.before=="function"?s.set(`${t.name}_before`,t.before):n.set(`${t.name}_before`,l(this,A).call(this,t.before))),e.set(`${t.name}_undo`,(o,a)=>({value:a.value.value,timestamp:a.value.timestamp})),t.undo&&n.set(`${t.name}_undo`,l(this,A).call(this,t.undo)),e.set(`${t.name}_redo`,(o,a)=>({value:a.value.value,timestamp:a.value.timestamp})),t.redo&&n.set(`${t.name}_redo`,l(this,A).call(this,t.redo)),t.after&&n.set(`${t.name}_after`,l(this,A).call(this,t.after)),!!t.actions&&t.actions.length!==0)for(let o of t.actions){if(o.name.includes("_"))throw console.log(o.name),"Cannot use '_' in action name";if(e.has(`${t.name}_${o.name}`))throw console.log(o.name),"already exist action name";s.set(`${t.name}_${o.name}`,o.method),e.set(`${t.name}_${o.name}`,s.get(`${t.name}_${o.name}`))}}),f(this,A,t=>typeof t!="function"?t:new Rt().subscribe(t)),f(this,Z,t=>{let{inputState:e}=t,s=(n=e,o)=>{if(!this.actions.has(o.type)||s.stateName!==o.type.split("_")[0])return n;const a=this.actions.get(o.type);if(!a)return n;if(o.type.includes("_undo")||o.type.includes("_redo")||o.type.includes("_update"))return a(n,o)||n;{o.value||(o.value=n.value);let{value:u}=a(o)||n;return{value:u,timestamp:Date.now()}}};return s.stateName=t.name,t.reducer=s,t}),f(this,tt,(t,e)=>{let{name:s,value:n,reducer:o}=t;switch(e&&t.initialState&&(n=t.initialState.value),this.store.dispatch({type:"initial$_update",value:{name:s,value:n},isSilent:e}),e){case"undo":this.record.dispatch({type:`${s}_undo`});break;case"redo":this.record.dispatch({type:`${s}_redo`});break}this.reducers[s]=o,this.store.replaceReducer(P(this.reducers)),this.parameters.set(s,t)})}}Q=new WeakMap,A=new WeakMap,Z=new WeakMap,tt=new WeakMap;class _e extends be{constructor(){return super(),this.build=()=>{this.setRecord();const t=this.setStore();return this.setReducer(),t},this.build()}}const ge=Rt,me=new _e;h.m$=me,h.stateObservable=ge,Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
